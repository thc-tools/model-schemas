{
    "title": "Universal database model",
    "$id": "http://github.com/thc-tools/schemas/data-schema.json",
    "description": "This schema describes a database data model, based on domains, entities and associations",
    "default": null,
    "definitions": {   
        "data-model": {
            "type": "object",
            "properties": {
                "guid":{
                    "$ref":"common-schema.json#/definitions/guid"
                },
                "name": {
                    "type": "string"
                },
                "description": {
                    "type": "string"
                },
                "tables": {
                    "type": "array",
                    "uniqueItems": true,
                    "items": {
                        "$ref": "#/definitions/table"
                    }
                }
            }
        },
        "table":{
            "allOf": [
                {"$ref":"common-schema.json#/definitions/entity"}
            ],
            "properties": {
              "columns":{
                  "type":"array",
                  "uniqueItems": true,
                  "items":{
                      "$ref": "common-schema.json#/definitions/field"
                  }
              },
              "constraints":{
                "type":"array",
                "uniqueItems": true,
                "items":{ "anyOf": [
                    {"$ref":"#/definitions/simple"},
                    {"$ref":"#/definitions/foreignKey"},
                    {"$ref":"#/definitions/default"},
                    {"$ref":"#/definitions/check"},
                    {"$ref":"#/definitions/index"}
                    ]}
                }
            }
        },
        "simple":{
            "columns":{
                "oneOf":[
                        {"type":"array",
                        "items":{
                            "$ref":"common-schema.json#/definitions/guid"
                        }, 
                        "uniqueItems":true
                    },
                    {"$ref":"#common-schema.json#/definitions/guid"}
            ]},
            "constraint":{"enum":["notNull", "unique", "primaryKey", "autoIncrement"]},
            "required":["columns","constraint"]
        },
        "foreignKey":{
            "columns":{
                "oneOf":[{
                "type":"array",
                    "items":[
                        {"ownColumn":{"$ref":"common-schema.json#/definitions/guid"}, 
                        "referencedColumn":{"$ref":"common-schema.json#/definitions/guid"}}
                    ]
                },
                {   
                    "ownColumn":{"$ref":"common-schema.json#/definitions/guid"}, 
                    "referencedColumn":{"$ref":"common-schema.json#/definitions/guid"}
                }
                ]
            },
            "referencedTable":{
                "$ref":"common-schema.json#/definitions/guid"
            },
            "required":["columns", "referencedTable"]
        },
        "default":{
            "column":{
                "$ref":"common-schema.json#/definitions/guid"
            },
            "defaultValue":{
                "type":["string", "number","boolean"]
            },
            "required":["column", "defaultValue"]
        },
        "check":{
            "conditions":{"$ref":"common-schema.json#/definitions/condition"},
            "required":["conditions"]
        },
        "index":{
           "columns":{"oneOf":[
                {"type":"array",
                "items":{
                    "$ref":"common-schema.json#/definitions/guid"
                }, 
                "uniqueItems":true
                },
                {"$ref":"#common-schema.json#/definitions/guid"}
                ]
            },
            "unique":{
                "type":"boolean"
            },
            "required":["columns", "unique"]
        }
    },
    "type":"object",
    "properties": {
        "database": {
                "$ref": "#/definitions/data-model"
        }
    }
}
